<!DOCTYPE HTML>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head th:include="console/header">
</head>

<body>
<script type="text/javascript" src="/static/js/echarts/echarts-all.js"></script>
    <section class="content-header">
        <h1>奖惩事件统计结果查询</h1>
    </section>
   <section class="content-header">
               <fieldset> 	
		<legend>查询条件</legend>
            <form id="searchbar" class="form-horizontal">
                <div class="form-group">
                <label for="unitId" style="width:130px" class="col-sm-2 control-label">机构·科室</label>
                    <div class="col-sm-2">
                        <input type="text" class="form-control tonto-select-unit" name="unitId" required="required" placeholder="请选择"></input>
                    </div>
                    <label for="unitId" style="width:130px" class="col-sm-2 control-label">奖惩事件类型</label>
                    <div class="col-sm-2">
                       <select id="dictCode" name="dictCode" class="form-control tonto-select-constant" enumcode="event_type">
				           <option value="">请选择</option>
				      </select>
                    </div>
                    <div class="col-sm-2" style="text-align:left">
                        <a onclick="query()" class="btn btn-primary">查询</a>
                        <button type="reset" class="btn">重置</button>
                    </div>
                </div>
            </form>
        </fieldset>
    </section>
		<section class="content-header">
			<div class="panel panel-default">
			    <div class="panel-body">
			       <div class="form-group">
				<div class="col-sm-12">
					<div id="dataGrid" style="width: 50%; margin: 0 auto;">
					<table  class="table table-bordered">
					<thead >
					<tr class="active"><th>事件类型</th><th>人数</th></tr>
					</thead>
					<tbody id="tbody">
					</tbody>
					<tr id="count"></tr>
					</table>
					</div>
				</div>
			</div>
			<div class="form-group">
				<div class="col-sm-6">
					<div id="main" style="height: 400px"></div>
				</div>
				<div class="col-sm-6">
					<div id="main2" style="height: 400px"></div>
				</div>
			</div>
			    </div>
			</div>
	</section>
	<div th:include="console/footer"></div>
    <script type="text/javascript">
  //<![CDATA[
	var myChart = echarts.init(document.getElementById('main'));
	var myChart2 = echarts.init(document.getElementById('main2'));
	function tuxing(myChart) {
		var unitId = $("#unitId").val();
		var dictCode = $("#dictCode").val();
		$.postAjax("/prize/count/search/all?unitId=" + unitId
				+ "&dictCode=" + dictCode, function(
				result) {
			var dicts = result.dicts;
			var list = result.list;
			var chartData = [];
			var charDatazx = [];
			var cache = {};
			var count=0;
			$("#tbody").empty();
			$("#count").empty();
			list.forEach(function(item) {
				if (item.dictName) {
					for (var i = 0; i < dicts.length; i++) {
						if (dicts[i].dictName == item.dictName) {
							chartData.push({
								name : dicts[i].dictName,
								value : item.count
							});
							charDatazx.push(dicts[i].dictName);
							count=count+item.count;
							
							$("#tbody").append("<tr><td>"+dicts[i].dictName+"</td><td>"+item.count+"</td></tr>");
							cache[dicts[i].dictName] = 1;
							break;
						}
					}
				}
			})
			$("#count").append("<td>合计</td><td>"+count+"</td>");
			for (var i = 0; i < dicts.length; i++) {
				if (!cache[dicts[i].dictName]) {
					chartData.push({
						name : dicts[i].dictName,
						value : 0
					});
					charDatazx.push(dicts[i].dictName);
					$("#tbody").append("<tr><td>"+dicts[i].dictName+"</td><td>0</td></tr>");
				}
			}

			var option1 = {
				title : {
					text : '考评结果汇总图',
				},
				tooltip : {
					trigger : 'axis'
				},
				toolbox : {
					show : true,
					width:40,
					padding : [ 20, 80, 5, 5 ],
					feature : {
						magicType : {
							show : true,
							type : [ 'line', 'bar' ]								
						}
					}
				},
				calculable : true,
				xAxis : [ {
					type : 'category',
					data : charDatazx,
					axisLabel: {  
						   interval:0,  
						   rotate:40  
						}  
					
				} ],
				 grid: { // 控制图的大小，调整下面这些值就可以，
		             x: 140,
		             x2: 90,
		             y2: 120,// y2可以控制 X轴跟Zoom控件之间的间隔，避免以为倾斜后造成 label重叠到zoom上
		         },
				yAxis : [ {
					type : 'value',
				} ],
				series : [ {
					barWidth : 30,
					name : '人数',
					type : 'bar',
					data : chartData,

				} ]
			}
			 var option2 = {
				tooltip : {
					trigger : 'item',
					formatter : "{a} <br/>{b} : {c} ({d}%)"
				},
				toolbox : {
					show : true,
					padding : [ 20, 80, 5, 5 ],
					feature : {
					}
				},
				calculable : true,
				series : [ {
					name : '访问来源',
					type : 'pie',
					radius : '55%',
					center : [ '50%', '45%' ],
					data : chartData,
				} ]
			};
			
			myChart.setOption(option1, true); 
			myChart2.setOption(option2, true); 
		});
	}

	var table;
	$(function() {
		tuxing(myChart);
	});

	function query() {
		tuxing(myChart);
	}

	// 关键词搜索框添加绑定回车函数
	$('body').bind('keypress', function(event) {
		if (event.keyCode == "13") {
			query();
		}
	});
	//]]>
    </script>
</body>

</html>