<!DOCTYPE HTML>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head th:include="/hf/header">
</head>

<body>
	<div class="container-fluid">
		<section class="content-header">
			<h1>医德医风档案管理</h1>
		</section>
		<section class="content-header">
			<fieldset>
				<legend>查询条件</legend>
				<form id="searchbar" class="form-horizontal">
					<div class="form-group">
						<label for="unitId" style="width: 130px"
							class="col-xs-2 control-label">被考评科室</label>
						<div class="col-xs-2">
							<input type="text" class="form-control tonto-select-unit"
								name="orgUnitId" th:attr="unitid=${query?.orgUnitId}"
								placeholder="请选择科室"></input>
						</div>
						<label for="name" style="width: 100px"
							class="col-xs-2 control-label">姓名</label>
						<div class="col-xs-2">
							<input type="text" name="name" th:value="${query?.name}"
								class="form-control" />
						</div>
						<label for="jobRank" style="width: 80px"
							class="col-xs-2 control-label">职称</label>
						<div class="col-xs-2">
							<select name="jobRank" class="form-control tonto-select-constant"
								th:attr="selectedvalue=${query?.jobRank}"
								enumcode="job-rank-type">
								<option value="">请选择</option>
							</select>
						</div>
						<label for="userProperty" style="width: 90px"
							class="col-xs-2 control-label">人员属性</label>
						<div class="col-xs-2">
							<select name="userProperty"
								class="form-control tonto-select-constant"
								th:attr="selectedvalue=${query?.userProperty}"
								enumcode="user_property_type">
								<option value="">请选择</option>
							</select>
						</div>
					</div>
					<div class="form-group">
						<label for="isAssessor" style="width: 130px"
							class="col-xs-2 control-label">是否考评人员</label>
						<div class="col-xs-2">
							<select name="isAssessor"
								class="form-control tonto-select-constant"
								th:attr="selectedvalue=${query?.isAssessor}"
								enumcode="boolean-type">
								<option value="">请选择</option>
							</select>
						</div>
						<label for="startRecordCreateTime" style="width: 100px"
							class="col-xs-2 control-label">建档时间</label>
						<div class="col-xs-2">
							<input type="text" name="startRecordCreateTime"
								th:value="${query}?(${query.startRecordCreateTime}?${#dates.format(query.startRecordCreateTime,'yyyy-MM-dd')})"
								class="form-control col-xs-2 tonto-datepicker-date"
								readonly="readonly" placeholder="请选择日期" />
						</div>
						<label for="endRecordCreateTime"
							style="width: 80px; text-align: center"
							class="col-xs-1 control-label">至</label>
						<div class="col-xs-2">
							<input type="text" name="endRecordCreateTime"
								th:value="${query}?(${query.endRecordCreateTime}?${#dates.format(query.endRecordCreateTime,'yyyy-MM-dd')})"
								class="form-control col-xs-2 tonto-datepicker-date"
								readonly="readonly" placeholder="请选择日期" />
						</div>
						<div class="col-xs-2" style="text-align: right">
							<a onclick="query()" class="btn btn-primary">查询</a>
							<button type="reset" class="btn">重置</button>
						</div>
					</div>
				</form>
				<input type="hidden" id="pageLimit" th:value="${query?.limit}" /> <input
					type="hidden" id="pageOffset" th:value="${query?.offset}" />
			</fieldset>
		</section>
		<section class="content table-content" style="margin-top: 10px">
			<table id="dataGrid"></table>
		</section>
		<div id="toolbar">
			<div class="btn-group">
				<a onclick="viewUser()" class="btn btn-default"><i
					class="glyphicon glyphicon-search"></i>查看</a> <a onclick="addUser()"
					class="btn btn-default"><i class="glyphicon glyphicon-plus"></i>新增</a>
				<a onclick="editUser()" class="btn btn-default"><i
					class="glyphicon glyphicon-edit"></i>修改</a> <a onclick="removeUser()"
					class="btn btn-default"><i class="glyphicon glyphicon-remove"></i>删除</a>
				<a onclick="resetPassword()" class="btn btn-default"><i
					class="glyphicon glyphicon-cog"></i>密码还原</a> <a onclick="importUser()"
					class="btn btn-default"><i class="glyphicon glyphicon-import"></i>导入</a>
				<a onclick="transferAskUser()" id="transferBtn"
					class="btn btn-default"><i class="glyphicon glyphicon-open"></i>人员转移申请</a>
			</div>
		</div>
	</div>
	<div th:include="/hf/footer"></div>
	<script type="text/javascript">
    /*<![CDATA[*/
    var table;
    $(function() {
        $.getConstantEnum(["boolean-type", "sex-type", "job-duties-type", "job-rank-type", "oeducation-type", "user_property_type"], initDataGrid);
        $.getAjax("/org/user/transfer/ask/count", function(data) {
            if (data && data > 0) {
                $("#transferBtn").append('<span class="badge bg-green" style="margin-left: 10px;">' + data + '</span>');
            }
        });
    });

    function initDataGrid(enumMap) {
        var limit = $("#pageLimit").val();
        var offset = $("#pageOffset").val();
        var page = (limit && offset) ? offset / limit + 1 : 1;

        table = $.createTable("#dataGrid", {
            idField: "id",
            columns: [
                [
                    { radio: true },
                    { title: "所在单位", field: "unitRootName" },
                    { title: "被考评科室", field: "unitName" },
                    { title: "是否考评人", field: "isAssessor", formatter: $.getEnumColumnFormatter(enumMap, "boolean-type") },
                    { title: "姓名", field: "name" },
                    { title: "性别", field: "sex", formatter: $.getEnumColumnFormatter(enumMap, "sex-type") },
                    { title: "人员属性", field: "userProperty", formatter: $.getEnumColumnFormatter(enumMap, "user_property_type") },
                    { title: "职称", field: "jobRank", formatter: $.getEnumColumnFormatter(enumMap, "job-rank-type") },
                    { title: "职务", field: "jobDuties", formatter: $.getEnumColumnFormatter(enumMap, "job-duties-type") },
                    { title: "学历", field: "oeducation", formatter: $.getEnumColumnFormatter(enumMap, "oeducation-type") },
                    { title: "建档时间", field: "recordCreateTime" }
                ]
            ],
            url: '/org/user/search/all',
            searchbar: '#searchbar',
            sortName: 'orgUnitId',
            showColumns: true,
            sortOrder: 'asc',
            pageSize: limit || undefined,
            pageNumber: page || 1,
            pagination: true,
            clickToSelect: true,
            toolbar: "#toolbar",
            showRefresh: true
        });
    }

    function addUser() {
        window.location = '/org/user/add/input';
    }

    function editUser() {
        var row = getSelectRow();
        if (row) {
            window.location = '/org/user/edit/input?id=' + row.id;
        } else {
            $.errorMessage("请选中一条业务数据");
        }
    }

    function removeUser() {
        var row = getSelectRow();
        if (row) {
            layer.confirm('确定删除吗?', function() {
                $.getAjax('/org/user/real/delete?id=' + row.id, function() {
                    $.successMessage("删除成功");
                    table.refresh();
                });
            });
        } else {
            $.errorMessage("请选中一条业务数据");
        }
    }

    function resetPassword() {
        var row = getSelectRow();
        if (row) {
            layer.confirm('<span style="color:red;">（还原后的密码为：000000），确定还原密码吗？</span>', function() {
                $.postAjax("/org/user/reset/password", { userId: row.id }, function() {
                    layer.msg("重置密码成功", { icon: 1 });
                });
            });
        } else {
            $.errorMessage("请选中一条业务数据");
        }
    }

    function viewUser() {

        var row = getSelectRow();
        if (row) {
            window.location = '/org/user/view?id=' + row.id;
        } else {
            $.errorMessage("请选中一条业务数据");
        }
    }

    function getSelectRow() {
        var rows = table.getSelections();
        return rows.length > 0 ? rows[0] : null;
    }

    function query() {
        table.refresh();
    }


    var importContent = '<div class="container-fluid"><form id="importForm" class="form-horizontal" style="padding:10px">' +
        '    <div class="form-group">' +
        '        <label for="unitId" class="col-xs-4 control-label">导入科室或机构</label>' +
        '        <div class="col-xs-8">' +
        '            <input type="text" class="form-control tonto-select-unit" name="unitId" placeholder="请选择科室"></input>' +
        '        </div>' +
        '    </div>' +
        '    <div class="form-group">' +
        '        <label for="file" class="col-xs-4 control-label">Excel文件</label>' +
        '        <div class="col-xs-8">' +
        '            <input type="file" id="file" name="file" class="form-control" />' +
        '        </div>' +
        '    </div>' +
        '    <div class="form-group">' +
        '        <label for="file" class="col-xs-4 control-label"></label>' +
        '        <div class="col-xs-6">' +
        '            <button type="button" style="width:80px" onclick="importSubmit()" class="btn btn-primary">提交</button>' +
        '            <a href="/static/excel/人员导入模板.xlsx" target="_blank" class="btn btn-danger"><i class="fa fa-download"></i>导入模板下载</a>' +
        '        </div>' +
        '    </div>' +
        '</form></div>';


    function importUser() {
        layer.open({
            type: 1,
            title: '导入人员',
            area: ['600px', '300px'],
            content: importContent,
            success: function(layero, index) {
                _initUnitComponment(layero);
            }
        });
    }

    function importSubmit() {

        var unit = $("input[name='unitId']").val();
        if (!unit) {
            $.errorMessage("请选择导入的科室或机构");
            return;
        }

        var filename = $("#file").val();
        if (!filename) {
            $.errorMessage("请选择导入的Excel文件");
            return;
        }

        if (filename.substr(filename.lastIndexOf(".") + 1) != 'xlsx') {
            $.errorMessage("请下载正确的模板填写");
            return;
        }

        $.ajaxFileUpload({
            url: '/org/user/import?unitId=' + unit, //用于文件上传的服务器端请求地址
            secureuri: false, //是否需要安全协议，一般设置为false
            fileElementId: 'file', //文件上传域的ID
            dataType: 'json', //返回值类型 一般设置为json
            success: function(data, status) //服务器成功响应处理函数
            {
                $.jsonResposneFunction(function(result) {
                    if (result) {
                        if (result.errorCount == 0) {
                            $.successAlert("导入成功");
                        } else {
                            var html = "<p>成功导入" + result.successCount + "条记录</p>";
                            result.errors.forEach(function(a) {
                                html += "<p>导入第<b>" + a.index + "</b>条记录失败：" + a.message + "</p>";
                            });

                            layer.alert(html, { icon: 2, area: ['600px', '400px'] });
                        }
                    } else {
                        $.successAlert("没有可导入的人员，是否正确使用模板");
                    }
                })(data);
            },
            error: function(data, status, e) //服务器响应失败处理函数
            {
                console.log(data);
            }
        })
        return false;
    }

    function transferAskUser() {
        window.location = "/org/user/transfer/ask/index";
    }


    // 关键词搜索框添加绑定回车函数
    $('body').bind('keypress', function(event) {
        if (event.keyCode == "13") {
            query();
        }
    });
    /*]]>*/
    </script>
</body>

</html>