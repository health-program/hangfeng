<!DOCTYPE HTML>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:shiro="http://www.pollix.at/thymeleaf/shiro ">

<head th:include="/hf/header"></head>

<body>
    <div class="container" style="padding-top:50px">
    <section class="content">
            <div class="col-md-8">
                <div class="box box-primary">
                    <div class="box-header with-border">
                        <h4 class="box-title">模板列表</h4>
                    </div>
                    <div class="box-body" style="height:600px;padding:20px">
                        <!-- <ul class="nav nav-pills nav-stacked" id="templateList">
                        </ul> -->
                        <table id="dataGrid" class="table table-hover"></table>
                        <div style="margin-top:20px">
                            <a href="/console/asscyc/index" class="btn btn-warning"><i class="glyphicon glyphicon-share-alt"></i>返回</a>
                        </div>                           
                    </div>
                </div>
            </div>
            <div class="col-md-4" id="itemEditor">
                <div class="box box-primary">
                    <div class="box-header with-border">
                        <h4 class="box-title">科室选择</h4>
                    </div>
                    <div class="box-body" id="unitTree" style="height:600px;overflow:auto;">
                    </div>
                </div>
            </div>
        <div th:include="/hf/footer"></div>
    </section>
    </div>
</body>
<script type="text/javascript">
/*<![CDATA[*/
var table;
var cycleId;
$(function() {
    cycleId = $.getUrlVariable("id");
    if (!cycleId) {
        $.failMessage("您没有选择考评周期");
        return;
    }

    $.getAjax("/console/asscyc/template/config?id=" + cycleId, function(data) {
        var relations = data.relations;
        var templates = data.templates;
        var agency = data.agency;

        if (templates) {
            templates.forEach(function(template) {
                var tempRelations = [];
                var templateId = template.id;
                if (relations) {
                    relations.forEach(function(relation) {
                        if (relation.templateId == templateId) {
                            tempRelations.push(relation);
                        }
                    });
                }
                template.relations = tempRelations;
            });
            createTemplateList(templates);
        }

        var g = function(unit) {
            unit.text = unit.name;
            if (relations) {
                relations.forEach(function(a) {
                    if (a.unitId == unit.id) {
                        unit.checkedTemplate = a.templateId;
                    }
                });
            }

            if (unit.children && unit.children.length > 0) {
                unit.nodes = unit.children;
                unit.nodes.forEach(g);
            }
        }

        if (agency.children) {
            g(agency);
            treedata = new Array(agency);
        }

    });

    tree = $("#unitTree");
});

var tree;
var currentTemplate;
var treedata;
var _activeRow;

function createTemplateList(templates) {
    // var container = $("#templateList");
    // templates.forEach(function(template) {
    //     var badge = template.relations.length;
    //     var li = $('<li><a href="javascript:void(0)">' + (badge > 0 ? '<span class="badge pull-right">' + badge : '') + '</span>' + template.templateName + '</a></li>')
    //     li.on("click", function() {
    //         if (_activeLi) {
    //             _activeLi.removeClass("active");
    //         }
    //         li.addClass("active");
    //         _activeLi = li;
    //         selectTemplate(template);
    //     });
    //     container.append(li);
    // });

    table = $.createTable("#dataGrid", {
        idField: "id",
        columns: [
            [
                { title: "模板名称", field: "templateName" },
                { title: "模板描述", field: "templateDescribe" }
            ]
        ],
        data: templates,
        pagination: false,
        onClickRow: function(row, element) {
            selectTemplate(row);
            if (_activeRow) {
                _activeRow.removeClass("success");
            }
            _activeRow = element;
            _activeRow.addClass("success");
        }
    });
}

function selectTemplate(template) {

    if (!treedata)
        return;

    currentTemplate = template;
    var a = function(node) {
        node.state = { checked: (node.checkedTemplate == currentTemplate.id) }
        if (node.nodes) {
            node.nodes.forEach(a);
        }
    }

    a(treedata[0]);

    tree.treeview({
        data: treedata,
        showCheckbox: true,
        onNodeChecked: nodeChecked,
        onNodeUnchecked: nodeUnchecked,
        levels: 5
    });
}


// function findNode(id, node) {

//     if (id == node.id) {
//         return node;
//     }

//     if (node.nodes) {
//         for (var i = 0; i < node.nodes.length; i++) {
//             var r = findNode(id, node.nodes[i]);
//             if (r)
//                 return r;
//         }
//     }

//     return null;
// }

function nodeCheckedChanged(node, checked) {

    // var n = findNode(node.id, treedata[0]);

    // if (!n)
    //     return;

    // if (checked) {
    //     n.checkedTemplate = currentTemplate.id;
    // } else {
    //     n.checkedTemplate = null;
    // }
}

var nodeCheckedSilent = false;

function nodeChecked(event, node) {
    if (nodeCheckedSilent) {
        return;
    }
    nodeCheckedSilent = true;
    checkAllParent(node);
    checkAllSon(node);
    nodeCheckedSilent = false;
}

var nodeUncheckedSilent = false;

function nodeUnchecked(event, node) {
    if (nodeUncheckedSilent)
        return;
    nodeUncheckedSilent = true;
    uncheckAllParent(node);
    uncheckAllSon(node);
    nodeUncheckedSilent = false;
}

//选中全部父节点
function checkAllParent(node) {
    nodeCheckedChanged(node, true);
    tree.treeview('checkNode', node.nodeId, { silent: true });
    var parentNode = tree.treeview('getParent', node.nodeId);
    if (!("nodeId" in parentNode)) {
        return;
    } else {
        checkAllParent(parentNode);
    }
}

//取消全部父节点
function uncheckAllParent(node) {
    nodeCheckedChanged(node, false);
    tree.treeview('uncheckNode', node.nodeId, { silent: true });
    var siblings = tree.treeview('getSiblings', node.nodeId);
    var parentNode = tree.treeview('getParent', node.nodeId);
    if (!("nodeId" in parentNode)) {
        return;
    }
    var isAllUnchecked = true; //是否全部没选中
    for (var i in siblings) {
        if (siblings[i].state.checked) {
            isAllUnchecked = false;
            break;
        }
    }
    if (isAllUnchecked) {
        uncheckAllParent(parentNode);
    }
}

//级联选中所有子节点
function checkAllSon(node) {
    nodeCheckedChanged(node, true);
    tree.treeview('checkNode', node.nodeId, { silent: true });
    if (node.nodes != null && node.nodes.length > 0) {
        for (var i in node.nodes) {
            checkAllSon(node.nodes[i]);
        }
    }
}

//级联取消所有子节点
function uncheckAllSon(node) {
    nodeCheckedChanged(node, false);
    tree.treeview('uncheckNode', node.nodeId, { silent: true });
    if (node.nodes != null && node.nodes.length > 0) {
        for (var i in node.nodes) {
            uncheckAllSon(node.nodes[i]);
        }
    }
}

/*]]>*/
</script>

</html>