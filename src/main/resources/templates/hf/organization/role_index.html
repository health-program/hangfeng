<!DOCTYPE HTML>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head th:include="console/header">
</head>

<body>
    <section class="content-header">
        <h1>角色管理</h1>
        <small>列表管理</small>
    </section>
    <section class="content table-content">
        <table id="dataGrid"></table>
    </section>
    <div id="toolbar">
        <a onclick="add()" class="btn btn-success"><i class="glyphicon glyphicon-plus"></i>添加角色</a>
    </div>
    <div th:include="console/footer"></div>
    <script type="text/javascript">
    /*<![CDATA[*/
    var table;
    $(function() {
        $.getConstantEnum(["role-level-type"], initDataGrid);
    });

    function initDataGrid(enumMap) {

        table = $.createTable("#dataGrid", {
            idField: "id",
            columns: [
                [
                    { title: "角色名称", field: "roleName" },
                    { title: "角色等级", field: "roleLevel", formatter: $.getEnumColumnFormatter(enumMap, "role-level-type") },
                    { title: "角色描述", field: "roleDesc" },
                    {
                        title: "查看",
                        width: "60px",
                        align: 'center',
                        events: {
                            'click .view': function(e, value, row, index) {
                                view(row);
                            }
                        },
                        formatter: $.viewColumnFormatter()
                    },{
                        title: "修改",
                        width: "60px",
                        align: 'center',
                        events: {
                            'click .edit': function(e, value, row, index) {
                                edit(row);
                            }
                        },
                        formatter: $.editColumnFormatter()
                    },
                    {
                        title: "授权",
                        width: "60px",
                        align: 'center',
                        events: {
                            'click .grant': function(e, value, row, index) {
                                grant(row);
                            }
                        },
                        formatter: $.tableColumnFormatter("授权", "grant")
                    }
                ]
            ],
            url: '/org/role/search/all',
            pagination: false,
            toolbar: "#toolbar",
            showRefresh: true,
            showToggle: true
        });
    }

    function add() {
        layer.open({
            type: 2,
            title: ' ',
            maxmin: true, //开启最大化最小化按钮
            content: '/org/role/add/input',
            area: $.getOpenLayerSize(800, 500),
            success: function(layero, index) {
                $.setLayerSubmitHandler(layero, index, function() {
                    layer.close(index);
                    table.refresh();
                }, "保存成功");
            }
        });
    }

    function edit(row) {

        if (row.isDefault == 1) {
            $.failMessage("默认角色无法修改");
            return;
        }

        layer.open({
            type: 2,
            title: ' ',
            maxmin: true, //开启最大化最小化按钮
            area: $.getOpenLayerSize(800, 500),
            content: '/org/role/edit/input?id=' + row.id,
            success: function(layero, index) {
                $.setLayerSubmitHandler(layero, index, function() {
                    layer.close(index);
                    table.refresh();
                }, "修改成功");
            }
        });
    }

    function view(row) {
        layer.open({
            type: 2,
            title: ' ',
            maxmin: true, //开启最大化最小化按钮
            area: $.getOpenLayerSize(800, 500),
            content: '/org/role/view?id=' + row.id
        });
    }


    function grant(row) {

        layer.open({
            type: 1,
            title: row.roleName,
            maxmin: true, //开启最大化最小化按钮
            area: $.getOpenLayerSize(500, 600),
            content: '<div style="padding: 0px;" id="roleMenuDiv"></div>',
            btn: ['保存'],
            btnAlign: 'c',
            yes: function(index, layero) {            
                var checkedNodes = tree.treeview("getChecked");

                var ids = [];

                if (checkedNodes && $.isArray(checkedNodes)) {
                    checkedNodes.forEach(function(a) {
                        ids.push(a.menuId);
                    });
                }

                var data = {
                    roleId: row.id,
                    menuId: ids
                }

                $.postAjax("/org/role/grant/save", data, function() {
                    $.successMessage("保存成功");
                    layer.close(index);
                })
            },
            success: function(layero, index) {
                $.getAjax("/org/role/grant?id=" + row.id, function(data) {
                    initTree(row.id, data, $("#roleMenuDiv"));
                });
            }
        });

    }


    // ----------------------------
    // 权限资源树
    // ----------------------------
    var tree;
    var treedata;

    function initTree(roleId, data, treeDiv) {

        tree = treeDiv;

        if (data.menus) {

            treedata = data.menus;
            var hasMenu = data.hasMenu;

            var a = function(nodes) {
                var arr = [];
                for (var i = 0; i < nodes.length;) {
                    var node = nodes[i];
                    if (node.isAdmin) {
                        nodes.splice(i, 1);
                        continue;
                    }

                    node.text = node.menuName + (node.isMenu ? '[菜单]' : '');
                    node.state = {
                        checked: hasMenu ? ($.inArray(node.menuId, hasMenu) != -1) : false
                    }

                    if (node.children && node.children.length > 0) {
                        node.nodes = a(node.children);
                    }

                    i++;
                    arr.push(node);
                }

                return arr;
            }

            a(treedata);

            tree.treeview({
                data: treedata,
                showCheckbox: true,
                onNodeChecked: nodeChecked,
                onNodeUnchecked: nodeUnchecked,
                levels: 5
            });



            /*    var saveBtn =$('<button type="button" class="btn btn-primary">保存</button>');
            //tree.append(saveBtn);
            saveBtn.click(function() {

                
            }); */
        }
    }


    function nodeCheckedChanged(node, checked) {}

    var nodeCheckedSilent = false;

    function nodeChecked(event, node) {
        if (nodeCheckedSilent) {
            return;
        }
        nodeCheckedSilent = true;
        checkAllParent(node);
        checkAllSon(node);
        nodeCheckedSilent = false;
    }

    var nodeUncheckedSilent = false;

    function nodeUnchecked(event, node) {
        if (nodeUncheckedSilent)
            return;
        nodeUncheckedSilent = true;
        uncheckAllParent(node);
        uncheckAllSon(node);
        nodeUncheckedSilent = false;
    }

    //选中全部父节点
    function checkAllParent(node) {
        nodeCheckedChanged(node, true);
        tree.treeview('checkNode', node.nodeId, { silent: true });
        var parentNode = tree.treeview('getParent', node.nodeId);
        if (!("nodeId" in parentNode)) {
            return;
        } else {
            checkAllParent(parentNode);
        }
    }

    //取消全部父节点
    function uncheckAllParent(node) {
        nodeCheckedChanged(node, false);
        tree.treeview('uncheckNode', node.nodeId, { silent: true });
        var siblings = tree.treeview('getSiblings', node.nodeId);
        var parentNode = tree.treeview('getParent', node.nodeId);
        if (!("nodeId" in parentNode)) {
            return;
        }
        var isAllUnchecked = true; //是否全部没选中
        for (var i in siblings) {
            if (siblings[i].state.checked) {
                isAllUnchecked = false;
                break;
            }
        }
        if (isAllUnchecked) {
            uncheckAllParent(parentNode);
        }
    }

    //级联选中所有子节点
    function checkAllSon(node) {
        nodeCheckedChanged(node, true);
        tree.treeview('checkNode', node.nodeId, { silent: true });
        if (node.nodes != null && node.nodes.length > 0) {
            for (var i in node.nodes) {
                checkAllSon(node.nodes[i]);
            }
        }
    }

    //级联取消所有子节点
    function uncheckAllSon(node) {
        nodeCheckedChanged(node, false);
        tree.treeview('uncheckNode', node.nodeId, { silent: true });
        if (node.nodes != null && node.nodes.length > 0) {
            for (var i in node.nodes) {
                uncheckAllSon(node.nodes[i]);
            }
        }
    }
    /*]]>*/
    </script>
</body>

</html>